---
author: kapucode
pubDatetime: 2022-09-30T15:22:00Z
title: Next.jsã¨OpenAIã§æ„Ÿæƒ…åˆ†æã‚¢ãƒ—ãƒªã‚’ä½œã‚‹
postSlug: nextjs-openai-amotion-app
featured: true
draft: false
tags:
  - nextjs
  - openai
  - prisma
  - supabase
  - clerk
description:
  Next.js13ã¨OpenAIã§æ„Ÿæƒ…åˆ†æã‚’ã—ã¦ãã‚Œã‚‹AIã‚¢ãƒ—ãƒªã®ä½œã‚Šæ–¹ã‚’è§£èª¬ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½ã‚’ä½œã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§æ„Ÿæƒ…åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯Prismaã‚’çµŒç”±ã—ã€Supabaseã«ä¿å­˜ã—ã¾ã™ã€‚æœ¬æ›¸ã§ã¯ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ—ãƒªã‚’ä½œã‚Šä¸Šã’ã¾ã™ğŸ’ªã€‚æ‰€ã€…Next.jsã®ã‚³ãƒ¼ãƒ‰é€²è¡Œã®ãƒã‚¤ãƒ³ãƒˆã‚’è§£èª¬ã—ã¦ã„ã¾ã™ã€‚Next.jsã®å…¥é–€æ›¸ã¨ã—ã¦ã‚‚ãŠä½¿ã„é ‚ã‘ã‚‹å†…å®¹ã«ãªã£ã¦ãŠã‚Šã¾ã™ğŸ˜ƒ
---

*è£œè¶³:
ãƒ»ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«Lexical(metaé–‹ç™ºã®ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿)ã‚’ä½¿ã„ã¾ã™ãŒæœ¬æ›¸ã®è¶£æ—¨ã¨ã¯ç•°ãªã‚‹ã®ã§Lexicalã®è§£èª¬ã¯æ·±ãã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚ï¼ˆè¦æœ›ãŒã‚ã‚Œã°è¿½è¨˜ã„ãŸã—ã¾ã™ï¼‰
ãƒ»OpenAI APIã‚­ãƒ¼ã®å–å¾—ã«ã¯ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚(åˆã‚ã®3ãƒ¶æœˆã¯$18ã¾ã§APIã®åˆ©ç”¨ãŒç„¡æ–™ã§ã§ãã¾ã™)


## Table of contents

## ã¯ã˜ã‚ã«
ã“ã®æœ¬ã¯Next.jsã¨OpenAIã‚’ä½¿ã„ã€ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã«æ–‡å­—ã‚’å…¥åŠ›ã™ã‚‹ã¨AIãŒå…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦æ„Ÿæƒ…åˆ†æã‚’ã—ã¦ãã‚Œã‚‹ã‚¢ãƒ—ãƒªã§ã™ã€‚
æ„Ÿæƒ…åˆ†æçµæœã‚’supabaseã«ä¿å­˜ã™ã‚‹ã¨ã“ã‚ã¾ã§ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

ãªãŠã€AIã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ·±ãèª¬æ˜ã—ã¦ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚Next.jsã«ã©ã†ã‚„ã£ã¦AIã‚’çµ„ã¿è¾¼ã‚€ã‹ã¨è¨€ã†AIã‚µãƒ¼ãƒ“ã‚¹é–‹ç™ºã®å…¥é–€ã«ãªã‚Šã¾ã™ã€‚èª­è€…æ§˜è‡ªèº«ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã®å½¢ã«ã™ã‚‹æ‰‹åŠ©ã‘ã‚’ã™ã‚‹ãŸã‚ã®æœ¬ã§ã™ã€‚

### ä½¿ç”¨æŠ€è¡“
ã“ã®æœ¬ã§ã¯ä»¥ä¸‹ã®æŠ€è¡“ã‚’å–ã‚Šæ‰±ã„ã¾ã™ã€‚
- Next.js(Typescript)
- Prisma(ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ä½œæˆ)
- supabaseï¼ˆãƒ‡ãƒ¼ã‚¿ç½®ãå ´)
- clerk(ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½)

Next.jsã§ã¯App routerã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### é–‹ç™ºå†…å®¹
é–‹ç™ºå†…å®¹ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚
- Prismaã§ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆæ–¹æ³•
- Clerkã§ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½å®Ÿè£…æ–¹æ³•
- OpenAIAPIã®ä½¿ã„æ–¹
- ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®åˆ†ææ–¹æ³•
- supabaseã¸ãƒ‡ãƒ¼ã‚¿ã®æ ¼ç´æ–¹æ³•

### äº‹å‰æº–å‚™
ãŠä½¿ã„ã®ãƒ‡ãƒã‚¤ã‚¹ã«ä»¥ä¸‹ã‚’ã‚¤ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠã„ã¦ãã ã•ã„
- node
- npm(ã‚‚ã—ãã¯yarn)
- ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿

### ãƒªãƒã‚¸ãƒˆãƒª
å®Œæˆã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã§ã™ã€‚
https://github.com/ryotarofr/Emotional-analysis-apps
<br />
ãƒ‡ãƒ¢ã‚µã‚¤ãƒˆ
https://emotional-analysis-apps.vercel.app/

### è³ªå•ãªã©ãŠå¾…ã¡ã—ã¦ã¾ã™
ã“ã“ãŒã‚ã‹ã‚Šã«ãã„ã¨ã‹è¬ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã¨ã‹ã‚ã‚Šã¾ã—ãŸã‚‰è³ªå•ã—ã¦ã„ãŸã ã‘ã‚Œã°éšæ™‚å¯¾å¿œã—ã¦ã„ãã¾ã™ã®ã§ã©ã‚“ã©ã‚“è³ªå•ã—ã¦ãã ã•ã„ã¾ã›ã€‚




## Next.jsã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
ä»Šå›ã¯Next.jsã®æœ€æ–°ç‰ˆã‚’ä½¿ã†ã®ã§ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
```bash
npx create-next-app@latest ./
```
åˆæœŸè¨­å®šã«ã¤ã„ã¦èã‹ã‚Œã¾ã™ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å¤§ä¸ˆå¤«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™
```
Ok to proceed? (y) y
âœ” What is your project named? â€¦ ./
âœ” Would you like to use TypeScript? â€¦ Yes
âœ” Would you like to use ESLint? â€¦ Yes
âœ” Would you like to use Tailwind CSS? â€¦ Yes
âœ” Would you like to use `src/` directory? â€¦ Yes
âœ” Would you like to use App Router? (recommended) â€¦ Yes
âœ” Would you like to customize the default import alias? â€¦ No
...
Success!
```
Success!ã¨è¡¨ç¤ºã•ã‚Œã‚Œã°å®Œäº†ã§ã™ã€‚

åˆæœŸè¨­å®šãŒçµ‚ã‚ã£ãŸã‚‰ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦http://localhost:3000/ã‚’ç«‹ã¡ä¸Šã’ã¦ãã ã•ã„
```
npm run dev
```

![](https://storage.googleapis.com/zenn-user-upload/8bbdd0ee5c05-20230927.png)
ã“ã®ã‚ˆã†ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ã§ã™ã€‚
ã“ã‚Œã§æœ€åˆã®æº–å‚™ã¯æ•´ã„ã¾ã—ãŸã€‚ã†ã¾ãå‹•ã‹ãªã„å ´åˆã¯ç’°å¢ƒè¨­å®šãŒã†ã¾ãã„ã£ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã®ã§ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã©ã‚’ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚


ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯é£›ã°ã—ã¦èª­ã¿é€²ã‚ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã„ã‚‰ãªã„ã‚ˆã£ã¦æ–¹ã¯ä»¥é™ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ã€‚
clerkã‚’ä½¿ãˆã°ã¨ã¦ã‚‚ç°¡å˜ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
[clerkå…¬å¼ã‚µã‚¤ãƒˆ](https://clerk.com/docs)


<br />
<br />

### clerkã®ã‚¢ãƒ—ãƒªè¨­å®š
å…¬å¼ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
Add applicationã‚’æŠ¼ã™ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒ ã‚’ä½¿ã†èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®è¨­å®šã‚’ã—ã¦create applicationã‚’æŠ¼ã—ã¾ã™ã€‚
ä»Šå›ã¯Email addresã¨Googleãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’ä½¿ã„ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/596b563cdf8e-20230927.png)


ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«.env.localã‚’ä½œæˆã—APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/5e675fa6dc82-20230927.png)


### clerkã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¡è¾¼ã¿ã¾ã™
```
npm i @clerk/nextjs
```



## clerkã§èªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…
ã‚ã¾ã‚Šæœ¬è³ªçš„ãªéƒ¨åˆ†ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã®ã§ãµãƒ¼ã‚“ã£ã¦æ€ã£ã¦ã‚‚ã‚‰ãˆã‚Œã°å¤§ä¸ˆå¤«ã§ã™ã€‚ã‚³ãƒ”ãƒšã§æ§‹ã„ã¾ã›ã‚“ã€‚
ã¾ãšã¯ã€ã‚¢ãƒ—ãƒªå…¨ä½“ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚’é©å¿œã•ã›ã¾ã™ã€‚
ClerkProviderã§ã‚¿ã‚°ã‚’ãƒ©ãƒƒãƒ—ã—ã¾ã™ã€‚
app/layout.tsx
```js
import { ClerkProvider } from '@clerk/nextjs'
...
...
export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <ClerkProvider> //è¿½åŠ 
      <html lang="en">
        <body className={inter.className}>{children}</body>
      </html>
    </ClerkProvider>ã€€ //è¿½åŠ 
  )
}

```

### èªè¨¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«èªè¨¼ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚
src/appãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­ã«æ¬¡ã®ãƒ•ã‚©ãƒ«ãƒ€ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„
![](https://storage.googleapis.com/zenn-user-upload/c4fd8bac720a-20230927.png)

Next.js13ã®App routerã§ã¯layout.tsxã‚„loading.tsxæ™‚ã¾ã£ãŸãƒšãƒ¼ã‚¸åãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚
layout.tsxã¯å…±é€šã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã‚„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç®¡ç†ã§ãã¾ã™ã€‚
(auth)ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚‹ã“ã¨ã§(auth)ãƒšãƒ¼ã‚¸ã ã‘ã®layout.tsxã‚’ä½œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
(auth)/layout.tsxã¨ã™ã‚‹ã“ã¨ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ç”»é¢ã®å…±é€šãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¦ªã®app/layout.tsxã‚’åˆ†ã‘ã¦æ±ºã‚ã‚‹ã“ã¨ãŒã§ãæµã®ã§ã‚ˆã‚ŠæŸ”è»Ÿã«é–‹ç™ºãŒã§ãã¾ã™ã€‚

app/(auth)/layout.tsx
```js
const AuthLayout = ({
  children
}: {
  children: React.ReactNode;
}) => {
  return (
    <main className="min-h-screen flex items-center justify-center">
      {children}
    </main>
  );
}

export default AuthLayout;
```

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç®¡ç†ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ«ãƒ€ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ã¦ãã ã•ã„
**app/components/ui**
ä»Šå›ã¯uiã¨ã„ã†ãƒ•ã‚©ãƒ«ãƒ€ã§ãƒœã‚¿ãƒ³ãªã©ã®uiã‚’ç®¡ç†ã—ã¾ã™ã€‚
ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹uiã‚’è¿½åŠ ã—ã¾ã™ã€‚
empty.pngã¯æ·»ä»˜ã—ãŸgithubã®publicãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‚ã®ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚

components/ui/empty.tsx
```js
import Image from "next/image";


interface EmptyProps {
  label: string;
}

export const Empty = ({
  label
}: EmptyProps) => {
  return (
    <div className="h-full p-20 flex flex-col items-center justify-center">
      <div className="relative h-72 w-72">
        <Image src="/empty.png" fill alt="Empty" />
      </div>
      <p className="text-muted-foreground text-sm text-center">
        {label}
      </p>
    </div>
  );
};
```

ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã‚’ä½œã‚Šã¾ã™ã€‚
:::message
ãƒã‚¤ãƒ³ãƒˆ
empty.tsxã«propsã‚’æŒãŸã›ã¦ã„ã¾ã™
label="Something went wrong."
ã“ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã‚¨ãƒ©ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’ã‚’ãƒšãƒ¼ã‚¸ã”ã¨ã«å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™
:::
"use client"ã¨è¡¨è¨˜ã™ã‚‹ã®ã¯Next.js13ã®app routerã§ã¯**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€Œ**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã‚ˆ**ã€ã¨Next.jsã«æ•™ãˆã¦ã‚ã’ã‚‹ãŸã‚ã§ã™ã€‚
ã€€ã‚¨ãƒ©ãƒ¼ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§è¡¨ç¤ºã•ã›ã‚‹ã®ã§ã“ã®ã‚ˆã†ãªè¨˜è¿°ãŒå¿…è¦ã«ãªã‚‹ã‚ã‘ã§ã™ã€‚
app/(auth)/error.tsx
```js
"use client"
import { Empty } from "../components/ui/empty";

const Error = () => {
  return (
    <Empty label="Something went wrong." />
  );
}

export default Error;

```

ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ»ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ ã—ã¾ã™ã€‚
ã“ã‚Œã‚‚ç°¡å˜ãªã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
(auth)/sign-in/[[...sign-in]]/page.tsx
```js
import { SignIn } from "@clerk/nextjs";

export default function Page() {
  return <SignIn />;
}
```

(auth)/sign-up/[[...sign-up]]/page.tsx
```js
import { SignUp } from "@clerk/nextjs";

export default function Page() {
  return <SignUp />;
};
```

ã‚³ãƒ¼ãƒ‰ãŒæ›¸ã‘ãŸã‚‰ã€€http://localhost:3000/ã€€ãŒä»¥ä¸‹ã®ã‚ˆã†ãªè¡¨ç¤ºã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/8f4ccd7a99c2-20230927.png)

ã—ã‹ã—ã€ãƒšãƒ¼ã‚¸ã«å…¥ã£ãŸã‚‰ã™ãã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã£ã¦ã¦ã®ã¯ã‚¢ãƒ—ãƒªã¨ã—ã¦ã¯å¤‰ã§ã™ã‚ˆã­ã€‚
ãã“ã§ã€publicRoutesã¨ã„ã†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªãã¦ã‚‚ã¿ã‚Œã¾ã™ã‚ˆã£ã¦è¨˜è¿°ã‚’ã—ã¦ã„ãã¾ã™ã€‚
ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã™ã€‚
src/middleware.ts
```js
import { authMiddleware } from "@clerk/nextjs";

export default authMiddleware({
  publicRoutes: ["/"],
});
```
ã“ã‚Œã§ http://localhost:3000/ ã®ãƒšãƒ¼ã‚¸ã§èªè¨¼ãƒšãƒ¼ã‚¸ã«é·ç§»ã—ãªã„ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’è¦‹ã‚‹ã¨
```bash
Clerk: The middleware was skipped for this request URL: http://localhost:3000/_next/static/chunks/app/page.js. For performance reasons, it's recommended to your middleware matcher to:
export const config = {
  matcher: ["/((?!.+\\.[\\w]+$|_next).*)","/","/(api|trpc)(.*)"],
};
```

ã“ã®ã‚ˆã†ãªè¡¨è¨˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«è¿½è¨˜ã—ã¾ã™ã€‚
ã“ã‚Œã¯Next.jsã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ã„ã„æ„Ÿã˜ã«ã—ã¦ãã‚Œã‚‹ãŠã¾ã˜ãªã„ã ã¨ã„ã†èªè­˜ã§å¤§ä¸ˆå¤«ã§ã™ã€‚
src/middleware.ts
```js
import { authMiddleware } from "@clerk/nextjs";

export default authMiddleware({
  publicRoutes: ["/"],
});

//è¿½åŠ 
export const config = {
  matcher: ["/((?!.*\\..*|_next).*)", "/", "/(api|trpc)(.*)"],
};
```

ãã—ã¦ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒ»ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ãŸã‚‰ã©ã“ã®ãƒšãƒ¼ã‚¸ã«é·ç§»ã™ã‚‹ã‹ã‚‚æ±ºã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
.env.localã«ä»¥ä¸‹ã®è¨˜è¿°ã‚’ã—ã¦ãã ã•ã„
ä»Šå›ã¯/noteã¨ã„ã†ãƒšãƒ¼ã‚¸ã«é·ç§»ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚
.env.local

```
//è¿½åŠ 
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/note
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/note
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ
Navbarã«èªè¨¼ãƒœã‚¿ãƒ³ã‚’å…¥ã‚Œã¦ã„ãã¾ã™ã€‚
components/Navbar/landing-navbar.tsx
ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚
ãã“ã«clerkã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
/landing-navbar.tsx
```js
"use client";
import Link from "next/link"
import { useAuth } from "@clerk/nextjs";

export const LandingNavbar = () => {
  const { isSignedIn } = useAuth();

  return (
    <nav>
        <Link
          href={isSignedIn ? "/note" : "/sign-up"}
        >
          ãƒ­ã‚°ã‚¤ãƒ³
        </Link>
    </nav>
  )
}

```

Tailwindcssã§å°‘ã—ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å½“ã¦ã¾ã™ã€‚
/landing-navbar.tsx
```js
"use client";

import Image from "next/image"
import Link from "next/link"
import { useAuth } from "@clerk/nextjs";

export const LandingNavbar = () => {
  const { isSignedIn } = useAuth();

  return (
    <nav
      className="mx-4 py-8 bg-transparent flex items-center justify-between
      md:mx-20
    ">
      <div className="flex items-center gap-x-2">
        <Link
          href={isSignedIn ? "/note" : "/sign-up"}
          className="no-underline text-white bg-indigo-900 px-4 py-2 rounded-full hover:bg-indigo-800"
        >
          ãƒ­ã‚°ã‚¤ãƒ³
        </Link>
      </div>
    </nav>
  )
}
```

ä½œã£ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¡¨ç¤ºã•ã›ã¾ã™
src/app/page.tsx
```js
//...
import { LandingNavbar } from './components/Navbar/landing-navbar'

export default function Home() {
  return (
    <main className="flex min-h-screen flex-col items-center justify-between p-24">
      <LandingNavbar /> //è¿½åŠ 
     // ...çœç•¥
    </main>
  )
}

```

ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆã‚’ç«‹ã¡ä¸Šã’ã¦ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
å®Ÿéš›ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã‚‹ã¨/noteã«ãƒšãƒ¼ã‚¸é·ç§»ã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/c64d3984e42e-20230928.png)


ã“ã‚Œã§èªè¨¼æ©Ÿèƒ½ã¯å‡ºæ¥ä¸ŠãŒã‚Šã§ã™ã€‚

<br />
<br />
Noteãƒšãƒ¼ã‚¸ã§ã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œã‚Šã¾ã™ã€‚

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚
app/(site)/layout.tsx
app/(site)/(routes)/note/page.tsx
(auth)ã®æ™‚ã¨åŒã˜ã‚ˆã†ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚Šã¾ã—ã™ã€‚
(site)ã¨ã„ã†åå‰ã«ã—ã¾ã—ãŸãŒã€ãªã‚“ã§ã‚‚ã„ã„ã§ã™ã€‚
(routes)ãƒ•ã‚©ãƒ«ãƒ€ã¯å€‹äººçš„ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒ2ã¤ä»¥ä¸Šã«ãªã‚‹å ´åˆã¯ã‚ã£ãŸã»ã†ãŒã„ã„ã‹ãªã¨æ€ã„ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/c5a447251b8b-20230928.png)

ãƒšãƒ¼ã‚¸ã®ç·¨é›†ã‚’ã—ã¦ã„ãã¾ã™ã€‚
(site)/layout.tsx
```js
const SiteLayout = ({
  children,
}: {
  children: React.ReactNode
}) => {

  return (
    <div>
      {children}
    </div>
  )
}

export default SiteLayout
```

(site)/(routes)/note/page.tsx
```js
const NotePage = () => {
return(<>
	<div>note</div>
</>)
}
```

è¦‹æ „ãˆãŒæ‚ªã„ã®ã§global.cssã‚’ä¿®æ­£ã—ã¾ã™ã€‚
app/global.css
```css
@tailwind base;
@tailwind components;
@tailwind utilities;

/* ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ */
/* :root {
  --foreground-rgb: 0, 0, 0;
  --background-start-rgb: 214, 219, 220;
  --background-end-rgb: 255, 255, 255;
} */

@media (prefers-color-scheme: dark) {
  :root {
    --foreground-rgb: 255, 255, 255;
    --background-start-rgb: 0, 0, 0;
    --background-end-rgb: 0, 0, 0;
  }
}

body {
  color: rgb(var(--foreground-rgb));
  background: linear-gradient(
      to bottom,
      transparent,
      rgb(var(--background-end-rgb))
    )
    rgb(var(--background-start-rgb));
}
```

<br />
<br />

ãƒãƒ£ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã§ã¯ã€æ„Ÿæƒ…åˆ†æã®çµæœã‚’ã‚°ãƒ©ãƒ•ã«æç”»ã—ã¦ã„ãã¾ã™ã€‚

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
noteã¨åŒã˜ã‚ˆã†ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚
app/(site)/(routes)/chart/page.tsx

ãƒšãƒ¼ã‚¸ã®ç·¨é›†ã‚’ã—ã¦ã„ãã¾ã™ã€‚
(site)/(routes)/chart/page.tsx
```js
const ChartPage = () => {

  return (
    <>
      <div>ãƒãƒ£ãƒ¼ãƒˆãƒšãƒ¼ã‚¸</div>
    </>
  )
}

export default ChartPage
```

### ãƒšãƒ¼ã‚¸é·ç§»ç”¨ã®(site)ã«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚’ä½œã‚‹
å…ˆã«ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ã†ã®ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
```bash
npm i react-icons
```
å…ˆã»ã©ä½œã£ãŸcomponents/Navbarã«ã€€**site-navbar.tsx**ã€€ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚
ãã‚Œã§ã¯ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚
components/Navbarsite-navbar.tsx
```js
"use client";

import { usePathname } from "next/navigation";
import Link from "next/link";
import Image from "next/image";
import { UserButton } from "@clerk/nextjs";
import { AiOutlineBarChart } from "react-icons/ai"
import { GiNotebook } from "react-icons/gi"

const navItems = [
  {
    path: "/note",
    name: "Note",
    icon: <GiNotebook size={24} />
  },
  {
    path: "/chart",
    name: "Chart",
    icon: <AiOutlineBarChart size={24} />
  },
];

export default function NavBar() {
  let pathname = usePathname() || "/";

  return (
    <div className=" p-[0.4rem] rounded-lg mb-12 sticky top-4 z-[100]">
      <div className="flex gap-2 relative justify-around items-center w-full z-[100]  rounded-lg">
        <div className="hidden sm:block">
          <Link href="/" className="flex items-center no-underline text-zinc-900">
            <Image width={36} height={36} alt="Logo" src="/logo.png" />
            <span className="text-2xl">
              My-App
            </span>
          </Link>
        </div>
        <div className="flex">
          {navItems.map((item, index) => {
            const isActive = item.path === pathname;

            return (
              <Link
                key={item.path}
                className={`px-4 py-2 rounded-md text-sm lg:text-base hover:bg-slate-200 relative no-underline duration-300 ease-in ${isActive ? "text-zinc-400" : "text-zinc-900"
                  }`}
                href={item.path}
              >
                <div className="flex items-center">
                  <div className="">{item.icon}</div>
                  <div className="hidden sm:block">{item.name}</div>

                </div>
              </Link>
            );
          })}
        </div>

        <UserButton afterSignOutUrl="/" />

      </div>
    </div>
  );
}
```

#### ã‚³ãƒ¼ãƒ‰ã®è§£èª¬
**usePathname**ã¯**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰**ã®hooksã§ã™ã€‚ãªã®ã§"use client"ã‚’ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
usePathnameã¯æ–‡å­—åˆ—ã‚’è¿”ã—ã¾ã™ãŒã€ä»¥ä¸‹ã®å ´åˆã«nullã‚’è¿”ã—ã¾ã™ã€‚
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒˆãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã¨ã
- Next.jsãŒè‡ªå‹•çš„ã«é™çš„æœ€é©åŒ–ã—ãŸãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¨ã
- ãƒ«ãƒ¼ã‚¿ãƒ¼ãŒæº–å‚™ã§ãã¦ã„ãªã„ã¨ã
ã“ã®ã‚ˆã†ãªå ´åˆã«ã€nullã‚’è¿”ã™ã®ã§ã¯ãªãã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‘ã‚¹åã‚’è¨­å®šã—ãŸã„ã¨ãã«ã€||ã¨ã„ã†æ¼”ç®—å­ã‚’ä½¿ã„ã¾ã™ã€‚||ã¯ã€è«–ç†å’Œï¼ˆORï¼‰ã¨å‘¼ã°ã‚Œã‚‹æ¼”ç®—å­ã§ã€å·¦å´ã®å€¤ãŒçœŸï¼ˆtruthyï¼‰ã§ã‚ã‚Œã°ãã®å€¤ã‚’è¿”ã—ã€å½ï¼ˆfalsyï¼‰ã§ã‚ã‚Œã°å³å´ã®å€¤ã‚’è¿”ã—ã¾ã™ã€‚nullã¯å½ã¨ã¿ãªã•ã‚Œã‚‹ã®ã§ã€usePathname()ãŒnullã‚’è¿”ã—ãŸã‚‰ã€å³å´ã®"/"ãŒä»£ã‚ã‚Šã«è¿”ã•ã‚Œã¾ã™ã€‚
```js
let pathname = usePathname() || "/";
```

navItemsã¨ã„ã†é…åˆ—ã‚’mapãƒ¡ã‚½ãƒƒãƒ‰ã§åå¾©å‡¦ç†ã—ã¦ã€å„è¦ç´ ã«å¯¾ã—ã¦Linkã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿”ã™ã‚‚ã®ã§ã™ã€‚Linkã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯Next.jsã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦ã€ãƒšãƒ¼ã‚¸é–“ã®é·ç§»ã‚’è¡Œã†ã‚‚ã®ã§ã™ã€‚
item.pathã¨ç¾åœ¨ã®ãƒ‘ã‚¹åï¼ˆpathnameï¼‰ãŒä¸€è‡´ã™ã‚‹ã‹ã©ã†ã‹ã‚’isActiveã¨ã„ã†å¤‰æ•°ã«ä»£å…¥ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã‚’åˆ¤åˆ¥ã™ã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œã¾ã™ã€‚
```js
...
{navItems.map((item) => {
            const isActive = item.path === pathname;

            return (
              <Link
                key={item.path}
                className={`px-4 py-2 rounded-md text-sm lg:text-base hover:bg-slate-200 relative no-underline duration-300 ease-in ${isActive ? "text-zinc-400" : "text-zinc-900"
                  }`}
                href={item.path}
              >
                <div className="flex items-center">
                  <div className="">{item.icon}</div>
                  <div className="hidden sm:block">{item.name}</div>

                </div>
              </Link>
            );
          })}
...
```

#### ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚’è¡¨ç¤ºã•ã›ã‚‹
ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã¯å…±é€šã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãªã®ã§(site)/layout.tsxã«è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚
(site)/layout.tsx
```js
import NavBar from "../components/Navbar/site-navbar"

const SiteLayout = ({
  children,
}: {
  children: React.ReactNode
}) => {

  return (
    <div>
      <NavBar />
      {children}
    </div>
  )
}

export default SiteLayout
```
ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã‚Œã¦ã„ã¾ã™ã€‚
ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒšãƒ¼ã‚¸ã®é·ç§»ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/b9bed3b2db21-20230928.png)


<br />
<br />

ä»Šå›Lexicalã«ã¤ã„ã¦æ·±ãè§£èª¬ã—ã¾ã›ã‚“ã€‚
ãŠæ‰‹æ•°ã§ã™ãŒã€app/componentsã«githubã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒšã—ã¦ãŠä½¿ã„ãã ã•ã„m(_ _)m
[Lexicalã‚¨ãƒ‡ã‚£ã‚¿](https://github.com/ryotarofr/lexacal-example)
â†“ã“ã“ã«ã‚³ãƒ”ãƒš
app/components/Editor/... 
![](https://storage.googleapis.com/zenn-user-upload/eb7acaf386ee-20230928.png)


### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ã¾ãšã¯ä»¥ä¸‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„
ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
lexicalã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯0.11.0ã‚’ä½¿ã„ã¾ã™ã€‚
ãƒªãƒƒãƒã‚¨ãƒ‡ã‚£ã‚¿ãƒ„ãƒ¼ãƒ«
```bash
npm install @lexical/list@0.11.0 @lexical/react@0.11.0 lexical@0.11.0
```
å‡¦ç†çµæœã®é€šçŸ¥ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
```bash
npm i react-hot-toast
```


### ãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã‚’è¡¨ç¤ºã•ã›ã‚‹
ã‚¨ãƒ‡ã‚£ã‚¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¡¨ç¤ºã•ã›ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
(site)/(routes)/note/page.tsx
```js
import { Editor } from "@/app/components/Editor/text-editor"

const NotePage = () => {

  return (
    <div>
      <Editor />
    </div>
  )
}

export default NotePage
```


#### ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
ã“ã¡ã‚‰ã‚‚ã‚³ãƒ”ãƒšã§ãŠä½¿ã„ãã ã•ã„
[ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚¹ã‚¿ã‚¤ãƒ«](https://github.com/ryotarofr/lexacal-example/blob/main/styles.css)
ä»¥ä¸‹ã®å ´æ‰€ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
(site)/styles.css
![](https://storage.googleapis.com/zenn-user-upload/e0c42e199f9d-20230928.png)

æœ€å¾Œã«layout.tsxã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©å¿œã•ã›ã¾ã™ã€‚
(site)/layout.tsx
```js
import "./styles.css"
```

#### ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆã‚’ç«‹ã¡ä¸Šã’ã¦ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
/noteã®ãƒšãƒ¼ã‚¸ã«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/50041e402505-20230928.png)

ã¡ãªã¿ã«ã§ã™ãŒã€ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã‚‚ãƒãƒƒãƒãƒªã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/606429b4510e-20230928.png)

<br />
<br />

OpenAIã®APIã‚’ä½¿ã£ã¦æ„Ÿæƒ…åˆ†æã‚’ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚
ã¯ã˜ã‚ã«OpenAIã®APIã‚­ãƒ¼ã‚’å–å¾—ã—ã¾ã™ã€‚(APIã‚­ãƒ¼ã®å–å¾—ã«ã¯ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚æœ€åˆã®3ãƒ¶æœˆã¯$18ã¾ã§ç„¡æ–™ã§ã™ã€‚ï¼‰
ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã‹ã‚‰
View API Keys >> Create new secret key
ã§APIã‚­ãƒ¼ã‚’ç™ºè¡Œã§ãã¾ã™ã€‚
[OpenAI ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://platform.openai.com/docs/introduction)
![](https://storage.googleapis.com/zenn-user-upload/817d9fce5cb7-20230928.png)


ãã‚Œã§ã¯ã€text-editor.tsxã«ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚
```js
//...
export function Editor() {
//è¿½åŠ 
    const [generateData, setGenarateData] = useState("{}")
//è¿½åŠ 
    // AIã«ãƒ‡ãƒ¼ã‚¿æ¸¡ã™
    // JSONã¨ã—ã¦è§£æ
    const parsedData = JSON.parse(generateData);
    // å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
    const textObjects: any = [];
    function extractText(obj: any) {
        // objãŒnullã‚„ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰returnã™ã‚‹
        if (!obj || Object.keys(obj).length === 0) return;
        if (obj.type === 'text') {
            textObjects.push(obj.text);
        } else if (obj.children && obj.children.length > 0) {
            obj.children.forEach((child: any) => extractText(child));
        }
    }
    // parsedData.rootãŒundefinedã§ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹
    if (parsedData.root) {
        extractText(parsedData.root);
    }
    const textData = textObjects.join(',')
    
//è¿½åŠ 
    const exportAsJson = (contenAsJson: string) => {
        setGenarateData(contenAsJson)
        return contenAsJson
    };
//...
    return (
        <LexicalComposer initialConfig={editorConfig}>
            <div className="editor-container">
                <ToolbarPlugin />
                <div className="editor-inner">
                    <RichTextPlugin
                        contentEditable={<ContentEditable className="editor-input" />}
                        placeholder={<Placeholder />}
                        ErrorBoundary={LexicalErrorBoundary}
                    />
                    <ListPlugin />
                    <HistoryPlugin />
                    <AutoFocusPlugin />
                    <CodeHighlightPlugin />
                    <LinkPlugin />
                    <TabIndentationPlugin />
                    <AutoLinkPlugin />
		{/* è¿½åŠ  */}		
                    <ExportPluginJson exportAsJSON={exportAsJson} />
                
		<MarkdownShortcutPlugin transformers={TRANSFORMERS} />
		{/* è¿½åŠ  GenarateButtonã¯ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ä½œã‚Šã¾ã™ã€‚ */}
                    <div className="flex justify-end">
                        <GenarateButton textData={textData} />
                    </div>
                </div>
		{/* ... */}
            </div>
        </LexicalComposer>
    );
}

```

#### ã‚³ãƒ¼ãƒ‰ã®è§£èª¬
Lexicalã§å…¥åŠ›ã—ãŸãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’stateã«æŒãŸã›ã¾ã™ã€‚
```js
 const [generateData, setGenarateData] = useState("{}")
 ```
 
 stateã¯jsonå½¢å¼ã§å‡ºåŠ›ã™ã‚‹ã®ã§Lexicalã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ã„ã¾ã™ã€‚
 ```js
 <ExportPluginJson exportAsJSON={exportAsJson} />
 ```
  exportAsJsonã¨ã„ã†é–¢æ•°ã«ã¯å…ˆã»ã©å®šç¾©ã—ãŸsetGenarateDataã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚
  
  :::details å…·ä½“çš„ã«ã¯ã“ã‚“ãªæ„Ÿã˜ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚
  ã“ã‚Œã¯ã€Œã“ã‚“ã«ã¡ã¯ã€ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚
{"root":{"children":[{"children":[{"detail":0,"format":0,"mode":"normal","style":"","text":"ã“ã‚“ã«ã¡ã¯","type":"text","version":1}],"direction":"ltr","format":"","indent":0,"type":"paragraph","version":1}],"direction":"ltr","format":"","indent":0,"type":"root","version":1}}
:::
 ```js
  const exportAsJson = (contenAsJson: string) => {
        setGenarateData(contenAsJson)
        return contenAsJson
    };
 ```
 
 æ¬¡ã«å…ˆã»ã©ã®Jsonãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠœãå‡ºã—ã¾ã™ã€‚
 å…ˆã»ã©ã®ä¾‹ã§è¡Œãã¨ã€Œã“ã‚“ã«ã¡ã¯ã€ã‚’æŠœãå‡ºã—ã¦ã„ãã¾ã™ã€‚

JSON.parse()ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ã«ã¯ä»¥ä¸‹ã®æ¡ä»¶ãŒã‚ã‚Šã¾ã™ã€‚
 :::details JSON.parse()ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ã«ã¯æ¡ä»¶ãŒã‚ã‚Šã¾ã™ã€‚
 1ã€€ã‚­ãƒ¼ï¼šå€¤ã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å›²ã‚€
```js
'{"name": "John"}' // æ­£ã—ã„
'{"name": 'John'}' // ã‚¨ãƒ©ãƒ¼ - ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¯èªè­˜ã•ã‚Œãªã„
```
 2 æ•°å€¤ã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãªã—
 ```js
 '{"age": 30}' // æ­£ã—ã„
'{"age": "30"}' // ã‚¨ãƒ©ãƒ¼ - ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å›²ã¾ã‚ŒãŸæ•°å€¤ã¯æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹
```

3 ç‰¹æ®Šæ–‡å­—ã‚’é©åˆ‡ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—(ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã¨ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãã®ã¾ã¾ä½¿ãˆãªã„ã®ã§\ã€€\ã‚’å‰ã«ã¤ã‘ã¾ã™ã€‚)
```js
'{"text": "This is a \\"quoted\\" string."}' // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
'{"path": "C:\\\\Documents\\\\file.txt"}' // ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
```
 :::
 
 ã“ã®ã‚ˆã†ã«ã™ã‚‹ã¨textDataã«ã€Œã“ã‚“ã«ã¡ã¯ã€ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã§ãã¾ã™ã€‚ã€‚
 ```js
    // AIã«ãƒ‡ãƒ¼ã‚¿æ¸¡ã™
    // JSONã¨ã—ã¦è§£æ
    const parsedData = JSON.parse(generateData);
    // å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
    const textObjects: any = [];

    function extractText(obj: any) {
        // objãŒnullã‚„ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰returnã™ã‚‹
        if (!obj || Object.keys(obj).length === 0) return;
        if (obj.type === 'text') {
            textObjects.push(obj.text);
        } else if (obj.children && obj.children.length > 0) {
            obj.children.forEach((child: any) => extractText(child));
        }
    }
    // parsedData.rootãŒundefinedã§ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹
    if (parsedData.root) {
        extractText(parsedData.root);
    }
    const textData = textObjects.join(',')
 ```
 
 æœ€å¾Œã«textDataã‚’GenarateButtonã«propsã«ã¾ã™ã€‚
 ```js
 <div className="flex justify-end">
	<GenarateButton textData={textData} />
</div>
 ```
 
 
 #### GenarateButtonã‚’ä½œã‚Šã¾ã™
 ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ã¦ãã ã•ã„ã€‚
 app/components/GenarateButton/index.tsx
 ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯OpenAIã®APIã‚’ä½¿ã£ã¦å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æ„Ÿæƒ…ã®å±æ€§ã‚’å‡ºåŠ›ã•ã›ã¾ã™ã€‚
 :::details æ„Ÿæƒ…ã®ç¨®é¡
negative: ãƒã‚¬ãƒ†ã‚£ãƒ–
  positive: ãƒã‚¸ãƒ†ã‚£ãƒ–
  neutral: ã©ã¡ã‚‰ã§ã‚‚ãªã„
  joy: æ¥½ã—ã„
  trust:ã€€ä¿¡é ¼
  fear:ã€€æã‚Œ
  surprise:ã€€é©šã
  sadness:ã€€æ‚²ã—ã¿
  disgust:ã€€é™ºæ‚ª
  anger:ã€€æ€’ã‚Š
  anticipation:ã€€æœŸå¾…
:::
 ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚
  app/components/GenarateButton/index.tsx
 ```js
 "use client"

import { useState } from "react";

export function GenarateButton({
  textData,
}: {
  textData: string
}) {
  const [isLoading, setIsLoading] = useState(false);
  const [generateData, setGenerateData] = useState<string[]>([]);

  const handleSubmit = async (e: { preventDefault: () => void }) => {
    e.preventDefault();
    if (textData === "") return;
    setIsLoading(true);
    // const API_KEY = process.env.OPENAI_API_KEY
    const API_KEY = "OpenAI API Keyã‚’è¿½åŠ "
    const model = "text-davinci-003";
    const URL = "https://api.openai.com/v1/engines/" + model + "/completions";

    const questions = `å‰ææ¡ä»¶ï¼šã‚ãªãŸã¯ã€ä¸–ç•Œã§ã‚‚æœ‰æ•°ã®ç²¾ç¥åˆ†æå®¶ã§ã™ã€‚
    æ–‡ç« ã‹ã‚‰ã€è‘—è€…ã®å¿ƒç†çŠ¶æ…‹ã‚’åˆ†æã™ã‚‹ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚
    æ¬¡ã®æ–‡ç« ã‚’ã‚‚ã¨ã«å¿ƒç†åˆ†æã—ã¦ãã ã•ã„ã€‚
    æ–‡ç« ã®è¿”ç­”å½¢å¼ã¯ãã‚Œãã‚Œã®æ„Ÿæƒ…å±æ€§ã«1~10ã¾ã§ã®ç‚¹æ•°ã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
    {EmotionalAnalysis:[
      {"negative":""},
      {"positive":""},
      {"neutral":""},
      {"joy":""},
      {"trust":""},
      {"fear":""},
      {"surprise":""},
      {"sadness":""},
      {"disgust":""},
      {"anger":""},
      {"anticipation":""}
    ]}
    ã®å½¢å¼ã§ç²¾ç¥åˆ†æã‚’ã—ã¾ã™ã€‚

    æ–‡ç« ï¼š${textData}
    `
    const res = await fetch(URL, {
      method: "POST",
      body: JSON.stringify({
        prompt: questions,
        max_tokens: 200,
      }),
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${API_KEY}`,
      },
    });

    const json = await res.json();

    const filterData = json.choices ? json.choices.map((value: { text: string }) => {
      const str = `{"EmotionalAnalysis":`
      const i = value.text.indexOf(str);
      return value.text.substring(i);
    }) : [];

    setGenerateData(filterData);
    setIsLoading(false);

  };

  return (
    <>
        <button
          onClick={handleSubmit}
          className="mx-4 mb-2 mt-2 text-md cursor-pointer rounded-lg border-none px-4 py-2 bg-lime-600 hover:bg-lime-700 text-white"
        >
          Generate
        </button>
        <p>{isLoading ? "loading" : null}</p>
	{/* ã¨ã‚Šã‚ãˆãšè¡¨ç¤º */}
        <div className="text-2xl">{generateData}</div>
    </ >

  )
}
 ```
 
 #### ã‚³ãƒ¼ãƒ‰ã‚’è§£èª¬
 ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨handleSubmité–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
 handleSubmitã®ä¸­ã§æ„Ÿæƒ…åˆ†æã‚’å®Ÿè£…ã—ã¾ã™ã€‚
 textDataãŒç©ºã®å ´åˆã¯ä½•ã‚‚å®Ÿè¡Œã—ã¾ã›ã‚“ã€‚
 ```js
 if (textData === "") return;
 ```
 
 handleSubmité–¢æ•°ã«asyncã¨ã—ã¦ã„ã‚‹ã‚ˆã†ã«ãƒ†ã‚­ã‚¹ãƒˆã®åˆ†æã¯éåŒæœŸã§è¡Œã†ã®ã§
 åˆ†æãŒçµ‚ã‚ã‚‹ã¾ã§ã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤ºã•ã›ã¾ã™ã€‚
 ```js
 setIsLoading(true);
 ```
 
 ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§apiã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚
 æœ¬æ¥APIã‚­ãƒ¼ãªã©ã®ä»–äººã«è¦‹ã›ãŸããªã„ã‚‚ã®ã¯.envãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã—ã¾ã™ãŒã€
 const API_KEY = process.env.OPENAI_API_KEYã“ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã¨APIã‚­ãƒ¼ã‚’å‘¼ã³å‡ºã›ãªã„ã®ã§ä»Šå›ã¯ç›´ã«æ›¸ã„ã¦ã„ã¾ã™ã€‚(ä¿®æ­£æ–¹æ³•æ¢ã—ã¾ã™)
 ä»Šå›ã¯ã€text-davinci-003ã¨ã„ã†ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã„ã¾ã™ã€‚text-davinci-003ã¯ãƒ†ã‚­ã‚¹ãƒˆã‚¸ã‚§ãƒãƒ¬ã‚¤ãƒˆã«å„ªã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚
 questionsã«æ¡ä»¶ã‚’è¨˜å…¥ã—ã¦ãã‚Œã‚’Postãƒ¡ã‚½ãƒƒãƒ‰ã®bodyã«å…¥åŠ›ã—ã¦ã„ã¾ã™ã€‚
 æ–‡ç« ã«ã¯ä»£å…¥æ¼”ç®—å­ã¦textDataã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚
 textDataã¯å…ˆã»ã©Jsonæ–‡å­—åˆ—ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠœãå‡ºã—ãŸãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚
 APIã‹ã‚‰å¸°ã£ã¦ããŸãƒ‡ãƒ¼ã‚¿ã‚’jsonã¨ã„ã†å®šæ•°ã«ä»£å…¥ã—ã¦ã„ã¾ã™ã€‚
 ```js
 const API_KEY = "OpenAI API Keyã‚’è¿½åŠ "
    const model = "text-davinci-003";
    const URL = "https://api.openai.com/v1/engines/" + model + "/completions";

    const questions = `å‰ææ¡ä»¶ï¼šã‚ãªãŸã¯ã€ä¸–ç•Œã§ã‚‚æœ‰æ•°ã®ç²¾ç¥åˆ†æå®¶ã§ã™ã€‚
    æ–‡ç« ã‹ã‚‰ã€è‘—è€…ã®å¿ƒç†çŠ¶æ…‹ã‚’åˆ†æã™ã‚‹ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚
    æ¬¡ã®æ–‡ç« ã‚’ã‚‚ã¨ã«å¿ƒç†åˆ†æã—ã¦ãã ã•ã„ã€‚
    *æ–‡ç« ã®è¿”ç­”å½¢å¼ã¯ãã‚Œãã‚Œã®æ„Ÿæƒ…å±æ€§ã«1~10ã¾ã§ã®ç‚¹æ•°ã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
    {EmotionalAnalysis:[
      {"negative":""},
      {"positive":""},
      {"neutral":""},
      {"joy":""},
      {"trust":""},
      {"fear":""},
      {"surprise":""},
      {"sadness":""},
      {"disgust":""},
      {"anger":""},
      {"anticipation":""}
    ]}
    ã®å½¢å¼ã§ç²¾ç¥åˆ†æã‚’ã—ã¾ã™ã€‚

    æ–‡ç« ï¼š${textData}
    `
    const res = await fetch(URL, {
      method: "POST",
      body: JSON.stringify({
        prompt: questions,
        max_tokens: 200,
      }),
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${API_KEY}`,
      },
    });

    const json = await res.json();
 ```
 
 jsonã«ã¯ä¸è¦ãªæ–‡ç« ã‚‚å«ã¾ã‚Œã‚‹ã®ã§å¿…è¦ãªéƒ¨åˆ†ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
:::details ã“ã‚“ãªãƒ‡ãƒ¼ã‚¿ãŒå¸°ã£ã¦ãã¾ã™
å…¥åŠ›: ã“ã‚“ã«ã¡ã¯ã€ç§ã¯æœãƒãƒŠãƒŠã‚’é£Ÿã¹ã¾ã—ãŸã€‚ãŠã„ã—ã‹ã£ãŸã§ã™ï¼ï¼
å‡ºåŠ›: ã“ã®æ–‡ç« ã‚’ã‚‚ã¨ã«å¿ƒç†åˆ†æã‚’ã—ã¾ã™ã€‚æ–‡ç« ã®è‘—è€…ã¯ã€æœãƒãƒŠãƒŠã‚’é£Ÿã¹ãŸã“ã¨ã«å¯¾ã—ã¦éå¸¸ã«å–œã³ã‚’æ„Ÿã˜ã¦ã„ã¾ã™ã€‚ã¾ãŸã€ãƒãƒŠãƒŠãŒãŠã„ã—ã‹ã£ãŸã¨ã„ã†ã“ã¨ã‹ã‚‰ã€å‘³è¦šã«å¯¾ã™ã‚‹æ„Ÿå—æ€§ãŒé«˜ã„ã¨æ¨æ¸¬ã§ãã¾ã™ã€‚ã•ã‚‰ã«ã€æ–‡ç« ã®èªå°¾ã«æ„Ÿå˜†ç¬¦ã‚’äºŒã¤ä½¿ã£ã¦ã„ã‚‹ã“ã¨ã‹ã‚‰ã€æ„Ÿæƒ…è¡¨ç¾ãŒè±Šã‹ã§ã€è‡ªåˆ†ã®æ°—æŒã¡ã‚’ç´ ç›´ã«ä¼ãˆã‚‹ã‚¿ã‚¤ãƒ—ã§ã‚ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚æ–‡ç« ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹æ„Ÿæƒ…å±æ€§ã®ç‚¹æ•°ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

{EmotionalAnalysis:[
  {"negative":"0"},
  {"positive":"10"},
  {"neutral":"0"},
  {"joy":"10"},
  {"trust":"0"},
  {"fear":"0"},
  {"surprise":"0"},
  {"sadness":"0"},
  {"disgust":"0"},
  {"anger":"0"},
  {"anticipation":"0"}
]}

ä»¥ä¸ŠãŒå¿ƒç†åˆ†æã®çµæœã§ã™ã€‚æ–‡ç« ã®è‘—è€…ã¯ã€æœãƒãƒŠãƒŠã‚’é£Ÿã¹ã‚‹ã“ã¨ã§å¹¸ã›ãªæ°—æŒã¡ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã­ğŸ˜Š
:::
å…·ä½“çš„ã«ã»ã—ã„ãƒ‡ãƒ¼ã‚¿{"EmotionalAnalysis":...}
ã‚’æŠ½å‡ºã—ã¾ã™ã€‚
```js
const filterData = json.choices ? json.choices.map((value: { text: string }) => {
      const str = `{"EmotionalAnalysis":`
      const i = value.text.indexOf(str);
      return value.text.substring(i);
    }) : [];
```

æœ€å¾Œã«filterDataã‚’è‰²ã€…ä½¿ã„å›ã™ãŸã‚ã«setGenerateDataã®stateã«ä»£å…¥ã—ã¾ã™ã€‚
handleSubmitã®å‡¦ç†ãŒçµ‚ã‚ã£ãŸã®ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’falseã«ã—ã¾ã™ã€‚
```js
setGenerateData(filterData);
setIsLoading(false);
```

ã¨ã‚Šã‚ãˆãšstateã®å€¤ã‚’è¡¨ç¤ºã•ã›ã¦ã„ã¾ã™ã€‚
ç§ã®ç”»é¢ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›çµæœã«ãªã£ã¦ã„ã¾ã™ã€‚
```js
{/* ã¨ã‚Šã‚ãˆãšè¡¨ç¤º */}
<div className="text-2xl">{generateData}</div>
```

![](https://storage.googleapis.com/zenn-user-upload/79496df6dec5-20230928.png)

ã“ã‚Œã§ãƒ‡ãƒ¼ã‚¿ã®ã‚¸ã‚§ãƒãƒ¬ã‚¤ãƒˆã¯å®Œäº†ã§ã™ã€‚
æ¬¡ã¯Prismaã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½œã‚Šã¾ã™ã€‚

<br />
<br />

Prismaã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
prismaã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```bash
npm install prisma --save-dev
npm install @prisma/client
```
```bash
npx prisma init
```

.envã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
```
# Environment variables declared in this file are automatically made available to Prisma.
# See the documentation for more detail: https://pris.ly/d/prisma-schema#accessing-environment-variables-from-the-schema

# Prisma supports the native connection string format for PostgreSQL, MySQL, SQLite, SQL Server, MongoDB and CockroachDB.
# See the documentation for all the connection string options: https://pris.ly/d/connection-strings

DATABASE_URL="postgresql://johndoe:randompassword@localhost:5432/mydb?schema=public"
```

.env.localã‚’.envã«ã‚³ãƒ”ãƒšã—ã¾ã™ã€‚(ä»¥é™.env.localã¯ä½¿ã‚ãªã„ã®ã§å‰Šé™¤ã—ã¾ã™ã€‚)
```
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_Y2hpZWYtYnVjay03OS5jbGVyay5hY2NvdW50cy5kZXYk
CLERK_SECRET_KEY=sk_test_eWY4OXh0aUqAYf2zrTM9ifFFyTpI5Np0nH6Ojb0B10

NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/note
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/note

DATABASE_URL="postgresql://johndoe:randompassword@localhost:5432/mydb?schema=public"
```

#### Supabaseã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«Supabaseã‚’ä½¿ã†ã®ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã—ã¦ã„ãã¾ã™ã€‚
ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãªã„å ´åˆã¯ä½œæˆã—ã¦ãã ã•ã„
[supabase ã‚µã‚¤ãƒ³ã‚¤ãƒ³](https://app.supabase.com/sign-in)


ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ç§»å‹•ã—ã¦
https://supabase.com/dashboard/projects
ã€ŒNew Project ãƒœã‚¿ãƒ³ã€ã‚’æŠ¼ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
Nameã¯ä»»æ„ã€Regionã¯Tokyoã€Pricingã¯ Freeã«è¨­å®šã—ã¦ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚
Freeã§ã¯500MBã¾ã§ DBãŒä½¿ãˆã¾ã™
![](https://storage.googleapis.com/zenn-user-upload/d3d974b2ded3-20230928.png)


æ¬¡ã«ã‚µã‚¤ãƒ‰ãƒãƒ¼ã® ã€Œsettingã€ > ã€ŒDatabaseã€> Connection string > url ã®æ–‡å­—åˆ—ã‚’ã‚³ãƒ”ãƒ¼ã€‚
ã“ã‚ŒãŒprismaãŒsupabaseã«æ¥ç¶šã™ã‚‹ãŸã‚ã®æƒ…å ±ã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/5252efa159bc-20230928.png)

urlã‚’.envã®DATABASE_URLã«ç½®ãæ›ãˆã¾ã™ã€‚
[ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰]ã®éƒ¨åˆ†ã‚’è¨­å®šã—ãŸã‚‚ã®ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
**test123**ã®å ´åˆã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```
//...
DATABASE_URL=postgresql://postgres:test123@db.idwitrlwanewneoypjki.supabase.co:5432/postgres
```

#### Prismaã®ã‚¹ã‚­ãƒ¼ãƒã‚’ä½œæˆ
è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸprisma/schema.prismaãƒ•ã‚¡ã‚¤ãƒ«ã«æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚
:::details modelã«ã¤ã„ã¦
modelã«ã¯ä¸»ã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚ä»Šå›ã¯idã‚’ä¸»ã‚­ãƒ¼ã«ã—ã€autoincrementã§é †ç•ªã«ç•ªå·ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚
testã¨userIdã¯?ã‚’ã¤ã‘nullã‚’è¨±å®¹ã—ã¦ã„ã¾ã™ã€‚
created_atã¯@default(now())ã§ä»Šã®æ™‚é–“ã‚’è‡ªå‹•ã§å‰²ã‚Šå½“ã¦ã¾ã™ã€‚
emotionã«ã¯æ„Ÿæƒ…åˆ†æã®çµæœãŒå…¥ã‚‹ã®ã§[]ã¨ã—ã¦é…åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚
:::
prisma/schema.prisma
```
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
//è¿½åŠ 
model Analysis {
  id         Int      @id @default(autoincrement())
  text       String?
  created_at DateTime @default(now())
  userId     String?
  emotion    String[]
}

```

ã“ã“ã¾ã§æ¥ã‚Œã° ã€Œmigrate devã€ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã—ã€supabaseã«åæ˜ ã•ã‚Œã¾ã™ã€‚
ã€Œ--nameã€ã«æŒ‡å®šã—ãŸåå‰ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã¾ã™ã€‚æ¬¡ã«generateã§å‹æƒ…å ±ã‚’ä½œæˆã—ã¾ã™ã€‚
```bash
npx prisma migrate dev --name init
npx prisma generate
```

ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«generateã‚’ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§
package.jsonã«è¿½åŠ ã—ã¾ã™ã€‚
```json
{
//...
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "postinstall": "prisma generate" //è¿½åŠ 
  },
  //...
}
```
<br />
<br />

### Prismaã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹
Next.jsã®apiãƒ«ãƒ¼ãƒˆã§Prismaã‚’ä½¿ã†ãŸã‚ã«ã¾ãšã¯Prismaã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚
app/libs/prismadb.tsã‚’ä½œã‚Šã¾ã™ã€‚
libsãƒ•ã‚©ãƒ«ãƒ€ã¯å¤–éƒ¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ä¾å­˜ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹æ™‚ã«ä½¿ã„ã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„APIã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹é–¢æ•°ã€èªè¨¼ã‚„èªå¯ã‚’è¡Œã†é–¢æ•°ãªã©ã¯ã“ã“ã«åã‚ã¦ã„ãã¾ã™ã€‚

app/libs/prismadb.ts
```js
import { PrismaClient } from "@prisma/client"

declare global {
  var prisma: PrismaClient | undefined
}

const prismadb = globalThis.prisma || new PrismaClient()
if (process.env.NODE_ENV !== "production") globalThis.prisma = prismadb

export default prismadb;

```

#### ã‚³ãƒ¼ãƒ‰ã®è§£èª¬
ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ prisma ã¨ã„ã†åå‰ã® Prisma Client ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å®£è¨€ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚PrismaClient | undefined ã¨ã„ã†å‹ã¯ã€prisma ãŒ Prisma Client ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã€æœªå®šç¾©ã‹ã‚’è¡¨ã—ã¾ã™ã€‚
```js
declare global {
  var prisma: PrismaClient | undefined
}
```

é–‹ç™ºç’°å¢ƒã§ã‚ã‚Œã°ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° prisma ã« prismadb ã®å€¤ã‚’ä»£å…¥ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€é–‹ç™ºç’°å¢ƒã§ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ãŒç™ºç”Ÿã—ãŸã¨ãã«ã€Prisma Client ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¤‡æ•°ä½œã‚‰ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
```js
if (process.env.NODE_ENV !== "production") globalThis.prisma = prismadb
```

###  APIä½œæˆ
#### å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
apiã‚’ä½œã‚‹ãŸã‚ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¿½åŠ 
app/api/analysis/route.ts

ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«ã¯Getã¨ã„ã†é–¢æ•°ã‚’ä½¿ã„ã¾ã™ã€‚
```js
import { NextResponse } from "next/server";
import { auth } from "@clerk/nextjs";
import prismadb from "@/app/libs/prismadb";

export const GET = async (req: Request, res: NextResponse) => {
  try {
    const { userId } = auth();
    const getAllText = await prismadb.analysis.findMany({
      where: {
        userId: userId
      }
    });
    return NextResponse.json({ message: "Success", getAllText }, { status: 200 });
  } catch (err) {
    return NextResponse.json({ message: "Error", err }, { status: 500 });
  } finally {
    await prismadb.$disconnect();
  }
};
```

##### ã‚³ãƒ¼ãƒ‰ã®è§£èª¬
apiã®é–¢æ•°ã¯åŸºæœ¬çš„ã«éåŒæœŸå‡¦ç†ã®ãŸã‚é–¢æ•°ã«asyncã‚’ã¤ã‘ã¾ã™ã€‚
try-catch-finallyæ–‡ã‚’ä½¿ã†ã¨ã‚¨ãƒ©ãƒ¼ã®å‡ºåŠ›ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚
tryã®ä¸­ã§ã¯ã¾ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç´ã¥ã‘ã‚‹ãŸã‚ã«clerkã‹ã‚‰å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚
ãã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«ç´ã¥ã„ãŸãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‘¼ã³å‡ºã™ã®ã§prismaã®findManyé–¢æ•°ã‚’ä½¿ã„ã¾ã™ã€‚
:::details ä»Šå›ä½¿ã£ãŸprismaé–¢æ•°ä¸€è¦§
findMany: whereã§æŒ‡å®šã—ãŸå…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‘¼ã³å‡ºã™
findFirst: whereã§æŒ‡å®šã—ãŸåˆã‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‘¼ã³å‡ºã™
create: bodyãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
update: bodyãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
delete: bodyãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
:::
```js
const { userId } = auth();
    const getAllText = await prismadb.analysis.findMany({
      where: {
        userId: userId
      }
    });
```

#### ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
æ¬¡ã¯ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã‚’ã™ã‚‹apiã‚’ä½œã‚Šã¾ã™ã€‚
app/api/analysis/route.ts
```js
export const POST = async (req: Request, res: NextResponse) => {
  try {
    const { userId } = auth();

    const { text } = await req.json();

    if (!userId) {
      return new NextResponse("Unauthorized", { status: 401 });
    }
    const createText = await prismadb.analysis.create({ data: { text, userId } });
    return NextResponse.json({ message: "Success", createText }, { status: 201 });
  } catch (err) {
    return NextResponse.json({ message: "Error", err }, { status: 500 });
  } finally {
    await prismadb.$disconnect();
  }
};

```

##### ã‚³ãƒ¼ãƒ‰ã®è§£èª¬
userãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã„å ´åˆã«ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
```js
if (!userId) {
      return new NextResponse("Unauthorized", { status: 401 });
    }
```
analysisã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã«text, userIdã‚’æ¸¡ã—ã¾ã™ã€‚textã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã™ã€‚
```js
   const createText = await prismadb.analysis.create({ data: { text, userId } });
```

#### ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿ã®APIã‚’ä½œæˆ
##### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¿½åŠ 
æŒ‡å®šã—ãŸidã®ãƒ‡ãƒ¼ã‚¿ã®apiã‚’ä½œã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚
api/analysis/[id]/route.ts

##### æŒ‡å®šã—ãŸidã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
api/analysis/[id]/route.ts
```js
import { NextResponse } from "next/server";
import prismadb from "@/app/libs/prismadb";

export const GET = async (req: Request, res: NextResponse) => {
  try {
    const id: number = parseInt(req.url.split("/analysis/")[1]);

    const getAnalysisById = await prismadb.analysis.findFirst({
      where: {
        id,
      }
    });

    if (!id) {
      return NextResponse.json({ message: "Not Found" }, { status: 404 });
    }

    return NextResponse.json({ message: "Success", getAnalysisById }, { status: 200 });
  } catch (err) {
    return NextResponse.json({ message: "Error", err }, { status: 500 });
  } finally {
    await prismadb.$disconnect();
  }
};
```

#### ã‚³ãƒ¼ãƒ‰ã®è§£èª¬
apiã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹éš›ã€ãƒ‡ãƒ¼ã‚¿ã®idãŒ1ã®ã‚‚ã®ã‚’å–å¾—ã™ã‚‹å ´åˆ
**http://localhost:3000/api/analysis/1**
ã“ã®ã‚ˆã†ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã™ã€‚
ãã®éƒ¨åˆ†ã®idã®ç•ªå·ã ã‘ãŒã»ã—ã„ã®ã§urlãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’splitã—ã¦idã‚’æŠœãå‡ºã—ã¾ã™ã€‚
```js
const id: number = parseInt(req.url.split("/analysis/")[1]);
```

findFirstã¯ä¸€ç•ªåˆã‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚(findUniqueã§ã‚‚å¯)
```js
const getAnalysisById = await prismadb.analysis.findFirst({
      where: {
        id,
      }
    });
```

idãŒãªã„æ™‚ã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã™ã€‚
```js
if (!id) {
      return NextResponse.json({ message: "Not Found" }, { status: 404 });
    }
```

##### æŒ‡å®šã—ãŸidã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
æŒ‡å®šã—ãŸidã®ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã‚’ã—ã¾ã™ã€‚
```js
export const PUT = async (req: Request, res: NextResponse) => {
  try {
    const id: number = parseInt(req.url.split("/analysis/")[1]);
    const { text } = await req.json();

    const putAnalysis = await prismadb.analysis.update({
      data: { text },
      where: {
        id,
      },
    });

    return NextResponse.json({ message: "Success", putAnalysis }, { status: 200 });
  } catch (err) {
    return NextResponse.json({ message: "Error", err }, { status: 500 });
  } finally {
    await prismadb.$disconnect();
  }
};
```
#### ã‚³ãƒ¼ãƒ‰ã®è§£èª¬
Postã¨ã»ã¨ã‚“ã©åŒã˜ã§ã™ãŒ
data: { text } ã“ã®ã‚ˆã†ã«dataã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¾ã™ã€‚
```js
const putAnalysis = await prismadb.analysis.update({
      data: { text },
      where: {
        id,
      },
    });
```

#### æŒ‡å®šã—ãŸIdã®å‰Šé™¤
prismadb.analysis.deleteã¨ã™ã‚‹ã“ã¨ã§ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã§ãã¾ã™ã€‚
```js
export const DELETE = async (req: Request, res: NextResponse) => {
  try {
    const id: number = parseInt(req.url.split("/analysis/")[1]);

    const deleteAnalysis = await prismadb.analysis.delete({
      where: { id },
    });

    return NextResponse.json({ message: "Success", deleteAnalysis }, { status: 200 });
  } catch (err) {
    return NextResponse.json({ message: "Error", err }, { status: 500 });
  } finally {
    await prismadb.$disconnect();
  }
};

```

#### æŒ‡å®šã—ãŸIdã®æ„Ÿæƒ…åˆ†æçµæœã®æ›´æ–°
æ„Ÿæƒ…åˆ†æã®çµæœã‚‚ãƒ†ã‚­ã‚¹ãƒˆã®æ›´æ–°ãŒã‚ã£ãŸéš›ã«ã€æ›´æ–°ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
##### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¿½åŠ 
openai/[id]/route.ts

å…ˆã»ã©ã¨é•ã†ã®ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«emotionã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚
ã“ã†ã™ã‚‹ã“ã¨ã§emotionã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã§ãã¾ã™ã€‚
```js
import { NextResponse } from "next/server";
import prismadb from "@/app/libs/prismadb";
import { auth } from "@clerk/nextjs";


export const PUT = async (req: Request, res: NextResponse) => {
  try {
    const { userId } = auth();
    const id: number = parseInt(req.url.split("/openai/")[1]);
    const { emotion } = await req.json();
    if (!userId) {
      return new NextResponse("Unauthorized", { status: 401 });
    }

    const putEmotion = await prismadb.analysis.update({
      data: { emotion },
      where: {
        id,
      },
    });

    return NextResponse.json({ message: "Success", putEmotion }, { status: 200 });
  } catch (err) {
    return NextResponse.json({ message: "Error", err }, { status: 500 });
  } finally {
    await prismadb.$disconnect();
  }
};
```

ã“ã‚Œã§apiã®ä½œæˆã¯å®Œäº†ã—ã¾ã—ãŸã€‚

<br />
<br />


## æŠ•ç¨¿ãƒœã‚¿ãƒ³ä½œæˆ
##### apiãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚§ãƒƒãƒã™ã‚‹ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
nom i axios
```
##### çŠ¶æ…‹ç®¡ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
npm i zustand
```


##### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
app/components/PostButton/index.tsx
apiãƒ•ã‚§ãƒƒãƒã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
app/hooks/useGetAllText.ts

##### å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
zustandã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§çŠ¶æ…‹ç®¡ç†ã‚’ã—ã¦ã„ã¾ã™ã€‚
çŠ¶æ…‹ç®¡ç†ã«ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚
:::details ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆ
ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä¸­ã ã‘ä½¿ã†ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ç®¡ç†
React Hooksã®useStateã‚„useReducerãªã©
:::
:::details ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆ
è¤‡æ•°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å…±æœ‰ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ç®¡ç†
React Hooksï¼šuseContext
å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼šReduxã€Recoilãªã©
:::
Getã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã¯è‰²ã€…ä½¿ã„å›ã™ã®ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã§ç®¡ç†ã—ã¾ã™ã€‚

app/hooks/useGetAllText.ts
```js
import { create } from "zustand";
import axios from "axios";

const useGetAllText = create((set) => ({
  data: [],
  loading: false,
  hasErrors: false,
  fetch: async () => {
    set(() => ({ loading: true }));
    try {
      const response = await axios.get(
        "/api/analysis"
      );
      set((state: any) => ({
        data: (state.data = response.data.getAllText),
        loading: false
      }));
    } catch (err) {
      set(() => ({ hasErrors: true, loading: false }));
    }
  },
}));

export default useGetAllText;
```
ã€€##### ã‚³ãƒ¼ãƒ‰ã®è§£èª¬
 ```js
data: [], //ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã®é…åˆ—ã‚’åˆæœŸåŒ–
loading: false, //ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã‹ã©ã†ã‹ã‚’è¡¨ã™ãŸã‚ã®çœŸå½å€¤ã‚’åˆæœŸåŒ–
hasErrors: false, //ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‹ã©ã†ã‹ã‚’è¡¨ã™ãŸã‚ã®çœŸå½å€¤ã‚’åˆæœŸåŒ–
fetch: async () => {...}, //ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚’è¡Œã†ãŸã‚ã®éåŒæœŸé–¢æ•°ã‚’å®šç¾©
set(() => ({ loading: true })); //loadingã®å€¤ã‚’trueã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚’é–‹å§‹

set((state: any) => ({ data: (state.data = response.data.getAllText), loading: false })); //ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã—ã¦dataã«ä»£å…¥ã—ã€loadingã®å€¤ã‚’falseã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒå®Œäº†ã—ãŸã“ã¨ã‚’è¡¨ã€‚stateã¯ç¾åœ¨ã®çŠ¶æ…‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ã™
set(() => ({ hasErrors: true, loading: false })); //hasErrorsã®å€¤ã‚’trueã«å¤‰æ›´ã—ã€loadingã®å€¤ã‚’falseã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã“ã¨ã‚’è¡¨ã™
```

#### Postãƒœã‚¿ãƒ³ã‚’ä½œæˆ
app/components/PostButton/index.tsx
```js
import { MdPlaylistAdd } from "react-icons/md";
import axios from "axios";
import { toast } from "react-hot-toast";
import useGetAllText from "@/app/hooks/useGetAllText";

export const CreateNaisei = () => {
  const { fetch }: any = useGetAllText()
  const defaultValue = '{"root":{"children":[{"children":[{"detail":0,"format":0,"mode":"normal","style":"","text":"example.","type":"text","version":1}],"direction":"ltr","format":"","indent":0,"type":"paragraph","version":1}],"direction":"ltr","format":"","indent":0,"type":"root","version":1}}'

  const onCreate = async (e: React.FormEvent) => {
    e.preventDefault();
    const apiUrl = "/api/naisei";
    const createData = {
      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿
      text: defaultValue,
    };
    await axios.post(apiUrl, createData)
      .then(response => {
        toast.success('Created Naisei!!')
        fetch()
        console.log("/editorã§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚§ãƒƒãƒ");
        return response
      })
      .catch(error => {
        console.error('Error fetching data:', error);
      });
  }
  return (

    <>
      <div className="max-w-2xl mx-auto text-end focus:outline-none">
        <button onClick={onCreate} className="border-none mr-8 cursor-pointer rounded-full hover:text-blue-600 bg-white">
          <MdPlaylistAdd size={48} color="" />
        </button>
      </div>
    </>
  )
}

```

#### ã‚³ãƒ¼ãƒ‰ã‚’è§£èª¬
onCreateã§ä½œæˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã™ã¨æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒä½œæˆã•ã‚Œã¾ã™ã€‚(Prismaã‚’é€šã—ã¦SUpabaseã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰
è¡¨ç¤ºç”»é¢ã«ã¯æ–°ã—ã„Postã®ãƒ‡ãƒ¼ã‚¿ãŒåæ˜ ã•ã‚Œã¦ãªã„ã®ã§ãƒ‡ãƒ¼ã‚¿ã‚’å†åº¦ãƒ•ã‚§ãƒƒãƒã—ã¾ã™ã€‚
```js
const { fetch }: any = useGetAllText() //å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
 const defaultValue = '{...}' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‡ãƒ¼ã‚¿
 await axios.post(apiUrl, createData) //ã“ã®ã‚ˆã†ã«ã—ã¦apiã—ã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µã‚¤ãƒˆãƒšãƒ¼ã‚¸ã«è¨ªã‚ŒãŸæ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚§ãƒƒãƒã—ã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã¯å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãªã®ã§layout.tsxã§è¡Œã„ã¾ã™ã€‚

ã¾ãšã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã‚’ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œã‚Šã¾ã™ã€‚
app/components/DataFetch/index.tsx
```js

"use client"


import useGetAllText from "@/app/hooks/useGetAllText";
import { useEffect } from "react";

export const DataFetch = () => {
  const { fetch }: any = useGetAllText()

  useEffect(() => {
    fetch()
    console.log("/editorã§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚§ãƒƒãƒ");
  }, [fetch])
  return (
    <>
    </>
  )
}
```

#### ã‚µã‚¤ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚
app/(site)/layout.tsx
```js
import "./styles.css"
import NavBar from "../components/Navbar/site-navbar"
import { DataFetch } from "../components/DataFetch"

const SiteLayout = ({
  children,
}: {
  children: React.ReactNode
}) => {

  return (
    <div>
      <NavBar />
      <DataFetch />
      {children}
    </div>
  )
}

export default SiteLayout
```

ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸéš›ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚


<br />
<br />

### ãƒ†ã‚­ã‚¹ãƒˆidã‚’ç®¡ç†ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã«ã¯1ã¤ã®Postã‚’è¡¨ç¤ºã•ã›ãŸã„ã®ã§idã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã§ç®¡ç†ã—ã¾ã™ã€‚
app/hooks/useGetTextById.ts
```js
import { create } from "zustand";

interface TextStore {
  analysisId: string[];
  selectedId: string | null;
  setAnalysisId: (naiseiId: any[]) => void;
  setSelectedId: (naiseiId: any) => void;
};

export const useGetTextById = create<TextStore>((set) => ({
  analysisId: [""],
  selectedId: null,
  setAnalysisId: (analysisId) => set({ analysisId }),
  setSelectedId: (analysisId) => set({ selectedId: analysisId }),
}));
```

### è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã«å…¥åŠ›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãŸã‚ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã§ã™ã€‚
app/hooks/useRefresh.ts
```js
import { create } from 'zustand';

type RefreshStore = {
  refresh: boolean;
  toggleRefresh: () => void;
};

const useRefresh = create<RefreshStore>((set) => ({
  refresh: false,
  toggleRefresh: () => set((state) => ({ refresh: !state.refresh })),
}));

export default useRefresh;
```

### ãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
app/components/Note/index.tsx
```js
"use client"

import { useEffect, useState } from "react";
import useRefresh from "@/app/hooks/useRefresh";
import useGetAllText from "@/app/hooks/useGetAllText";
import { useGetTextById } from "@/app/hooks/useGetTextById";

export const Note = () => {
  const [text, setText] = useState([])
  const { toggleRefresh } = useRefresh()
  const { data, loading }: any = useGetAllText()

  useEffect(() => {
    const resText = data.map((item: any) => item.text)
    const newArray = resText.map((item: any) => {
      const parsedItem = JSON.parse(item); // JSONæ–‡å­—åˆ—ã‚’JavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
      return parsedItem.root.children[0].children[0].text; // textã®å€¤ã‚’æŠ½å‡º
    });

    async function processData() {
      const replacedData: any = [];
      for (let i = 0; i < data.length; i++) {
        const item = { ...data[i] };
        try {
          const textObj = JSON.parse(item.text);
          if (textObj.root && textObj.root.children && textObj.root.children[0] && textObj.root.children[0].children) {
            const textValue = textObj.root.children[0].children[0].text;
            if (textValue === newArray[i]) {
              item.text = newArray[i];
            }
          }
        } catch (error) {
          console.error("Error parsing JSON:", error);
        }
        replacedData.push(item);
      }
      const newCreatedAt = replacedData.map((item: any) => {
        return {
          id: item.id,
          text: item.text,
          created_at: item.created_at.split('T')[0] // æ—¥ä»˜éƒ¨åˆ†ã ã‘ã‚’å–å¾—
        };
      });
      newCreatedAt.sort((a: any, b: any) => b.id - a.id); //æ—¥ä»˜ã‚’é™é †ã«ãªã‚‰ã¹æ›¿ãˆ
      setText(newCreatedAt)

    }
    processData();
  }, [data, setText])

  const handleItemClick = (textId: number) => {
    useGetTextById.getState().setSelectedId(textId);
    toggleRefresh();
    let timeoutId = setTimeout(() => {
      // Editorã®stateã‚’æ›´æ–°
      toggleRefresh();
    }, 100)
    return () => {
      clearTimeout(timeoutId)
    }
  };

  return (
    <div className="flex justify-center mx-4">
      <div className="max-w-2xl">
        {!loading
          ?
          <>
            {text.map((item: any) => (
              <div
                key={item.id}
                onClick={() => handleItemClick(item.id)}
                className="my-2 rounded-md cursor-pointer px-2"
              >
                <div className="text-start text-3xl break-words whitespace-pre-wrap">{item.text}</div>
                <div className="text-slate-400 text-end">{item.created_at}</div>
              </div>
            )
            )}
            {text.length <= 0 && <div className="text-lg">Make a post now!</div>}
          </>
          :
          <div>loading.....</div>
        }
      </div>
    </div>
  )
}
```

#### ã‚³ãƒ¼ãƒ‰ã‚’è§£èª¬
useEffectã®ä¸­ã§ã¯ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ã‚’ã—ã¦ã„ã¾ã™ã€‚
:::details å…·ä½“çš„ã«ã©ã‚“ãªæ•´å½¢ã‚’ã—ã¦ã‚‹ã‹
ãƒ†ã‚­ã‚¹ãƒˆ
æ•´å½¢å‰:'{"root":{"children":[{"children":[{"detail":0,"format":0,"mode":"normal","style":"","text":"example.","type":"text","version":1}],"direction":"ltr","format":"","indent":0,"type":"paragraph","version":1}],"direction":"ltr","format":"","indent":0,"type":"root","version":1}}'
æ•´å½¢å¾Œ: '**example.**'

ä½œæˆæ—¥
æ•´å½¢å‰: 2023-09-30T01:23:45
æ•´å½¢å¾Œ: **2023-09-30**
:::

#### textã®ä¸€ç•ªåˆã‚ã®è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã ã‘ã‚’å–å¾—
```js
const resText = data.map((item: any) => item.text)
    const newArray = resText.map((item: any) => {
      const parsedItem = JSON.parse(item); // JSONæ–‡å­—åˆ—ã‚’JavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
      return parsedItem.root.children[0].children[0].text; // textã®å€¤ã‚’æŠ½å‡º
    });
```

#### processData()ã¯å–å¾—ã—ãŸãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®textã®ä¸€ç•ªåˆã‚ã®è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã¨JSONå½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆãŒä¸€è‡´ã™ã‚‹ã‹æ¤œè¨¼ã™ã‚‹
```js
async function processData() {
      const replacedData: any = [];
      for (let i = 0; i < data.length; i++) {
        const item = { ...data[i] };
        try {
          const textObj = JSON.parse(item.text);
          if (textObj.root && textObj.root.children && textObj.root.children[0] && textObj.root.children[0].children) {
            const textValue = textObj.root.children[0].children[0].text;
            if (textValue === newArray[i]) {
              item.text = newArray[i];
            }
          }
        } catch (error) {
          console.error("Error parsing JSON:", error);
        }
        replacedData.push(item);
      }
      const newCreatedAt = replacedData.map((item: any) => {
        return {
          id: item.id,
          text: item.text,
          created_at: item.created_at.split('T')[0] // æ—¥ä»˜éƒ¨åˆ†ã ã‘ã‚’å–å¾—
        };
      });
      newCreatedAt.sort((a: any, b: any) => b.id - a.id); //æ—¥ä»˜ã‚’é™é †ã«ãªã‚‰ã¹æ›¿ãˆ
      setText(newCreatedAt)
    }
```

#### å®Ÿéš›ã«ç”»é¢ã®è¡¨ç¤º
```js
//ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒnullã®å ´åˆã«è¡¨ç¤º
 {text.length <= 0 && <div className="text-lg">Make a post now!</div>}
 
 // apiã®å‡¦ç†ä¸­ã¯loadingã‚’è¡¨ç¤º
  {!loading
          ?
	  //...
	  :
	  <div>loading.....</div>
        }
```


### ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãŒç”»é¢ã«è¡¨ç¤ºã—ã¦ã„ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚’è¨­ç½®ã—ã¦ã‚¨ãƒ‡ã‚£ã‚¿ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’ä½œã‚‹
:::message
ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ãƒˆã‚°ãƒ«ã•ã›ã‚‹ã ã‘ã§ã¯ã‚¹ãƒ†ãƒ¼ãƒˆã¯æ›´æ–°ã•ã‚Œã¾ã›ã‚“ã€‚
useRefreshã‚’ã†ã¾ãä½¿ã„ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°ã•ã›ã¾ã™
```js
{!refresh ?
              <>
                <Editor />
              </>
              :
              <div></div>
            }
```
:::


app/components/NoteItem/index.tsx
```js
"use client"

import useRefresh from "@/app/hooks/useRefresh";
import { useToggleEditor } from "@/app/hooks/useToggleEditor";
import { MdKeyboardBackspace } from "react-icons/md";


import { Editor } from "../Editor/text-editor";
import { PostButton } from "../PostButton";
import { Note } from "../Note";

export const NoteItem = () => {
  const { refresh } = useRefresh();
  const { isOpen, onClose, onOpen } = useToggleEditor()
  return (
    <>
      {
        isOpen ?
          <div className="max-w-3xl mx-auto">
            < div className="flex justify-start ml-4" >
              <button
                className="border-none cursor-pointer bg-white hover:text-blue-400"
                onClick={() => onClose()}
              >
                <MdKeyboardBackspace size={24} />
              </button>
            </div >
            {!refresh ?
              <>
                <Editor />
              </>
              :
              <div></div>
            }

          </div >
          :
          <>
            <PostButton />
            <div onClick={() => onOpen()}>
              <Note />
            </div>
          </>
      }

    </>
  )
}
```

### ãƒšãƒ¼ã‚¸ã«è¿½åŠ 
NoteItemã‚’ãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã«è¿½åŠ ã—ã¾ã™ã€‚
```js
import { NoteItem } from "@/app/components/NoteItem/intex"

const NotePage = () => {

  return (
    <div>
      <NoteItem />
    </div>
  )
}

export default NotePage
```

### å‹•ä½œç¢ºèª
å³ä¸Šã®+ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒèµ°ã‚Šæ–°ã—ã„Postã‚’ãƒ•ã‚§ãƒƒãƒã—ã¾ã™ã€‚
ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã§ã‚¨ãƒ‡ã‚£ã‚¿ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/273086b2bcf0-20230929.png)

<br />
<br />

##ã€€ã‚¨ãƒ‡ã‚£ã‚¿ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤ºã•ã›ã¦ã„ãã¾ã™ã€‚
app/components/editor/text-editor.tsx ã«ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™

app/components/Editor/text-editor.tsx
```js
'use client';
import { useEffect, useState } from "react";
import { useGetTextById } from "@/app/hooks/useGetTextById";
import useGetAllText from "@/app/hooks/useGetAllText";

export function Editor() {
    //è¿½åŠ 
    const [text, setText] = useState('')
    const [emotion, setEmotion] = useState('')
    const selectedId = useGetTextById((state) => state.selectedId)
    const { data, fetch }: any = useGetAllText()

   //è¿½åŠ 
    useEffect(() => {
        setText("")
        setEmotion('')
        if (selectedId !== null) {
            // dataé…åˆ—ã‹ã‚‰é¸æŠã•ã‚ŒãŸIDã«ä¸€è‡´ã™ã‚‹è¦ç´ ã‚’æ¢ã™
            const selectedData = data.find((item: any) => item.id === selectedId);
            if (selectedData) {
                setText(selectedData.text);
                setEmotion(selectedData.emotion)

            } else {
                setText(""); // ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç©ºã«è¨­å®š
            }
        } else {
            setText(""); // selectedNaiseiIdãŒnullã®å ´åˆã‚‚ç©ºã«è¨­å®š
        }
    }, [selectedId, data])


    const editorConfig = {
	editorState: text //è¿½åŠ 
    };

if (!text) return <></> //è¿½åŠ 
    return (
    {...}
        );
}

```

#### ã‚³ãƒ¼ãƒ‰ã®è§£èª¬
useEffectå†…ã§ãƒ‡ãƒ¼ã‚¿ã‚’mapã—ã€useStateã§ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ç®¡ç†ã—ã¾ã™ã€‚
```js
// stateã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚åˆæœŸåŒ–ã—ãªã„ã¨å‰å›ã®ã‚¹ãƒ†ãƒ¼ãƒˆãŒæ®‹ã‚Šç”»é¢è¡¨ç¤ºãŒå¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚
useEffect(() => {
        setText("")
        setEmotion('')
    }, [selectedId, data])
```

ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹æ™‚ã«å‡¦ç†ã‚’å®Ÿè¡Œã€‚ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚
```js
if (selectedId !== null) {
            // dataé…åˆ—ã‹ã‚‰é¸æŠã•ã‚ŒãŸIDã«ä¸€è‡´ã™ã‚‹è¦ç´ ã‚’æ¢ã™
            const selectedData = data.find((item: any) => item.id === selectedId);
            if (selectedData) {
                setText(selectedData.text);
                setEmotion(selectedData.emotion)

            } else {
                setText(""); // ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ç©ºã«è¨­å®š
            }
        } else {
            setText(""); // selectedNaiseiIdãŒnullã®å ´åˆã‚‚ç©ºã«è¨­å®š
        }
```

Lexicalã®ã‚¨ãƒ‡ã‚£ã‚¿ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¸¡ã—ã¾ã™ã€‚
ãƒ†ã‚­ã‚¹ãƒˆãŒnullã®å ´åˆã«ã¯ä½•ã‚‚è¡¨ç¤ºã•ã›ã¾ã›ã‚“ã€‚->ã“ã®ã‚³ãƒ¼ãƒ‰æ›¸ã‹ãªã„ã¨undifindã¨ãªã‚Š Json.paese ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
```js
 const editorConfig = {
	editorState: text //è¿½åŠ 
    };

if (!text) return <></> //è¿½åŠ 
```

ã“ã‚Œã§ã‚¨ãƒ‡ã‚£ã‚¿ã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/607a4e60e5c8-20230929.png)

<br />
<br />

## APIã‚’å©ã„ã¦ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã¨å‰Šé™¤ã®ãƒœã‚¿ãƒ³ã‚’ä½œã‚Šã¾ã™ã€‚
ä»Šå›ã¯ã€text-editor.tsxã«ãƒœã‚¿ãƒ³ã‚’ç›´æ¥æ›¸ã„ã¦ã„ãã¾ã™ã€‚
## ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
app/components/Editor/text-editor.tsx
```js
//è¿½åŠ 
import axios from "axios";
import { useGetTextById } from "@/app/hooks/useGetTextById";
import useGetAllText from "@/app/hooks/useGetAllText";
import { useToggleEditor } from "@/app/hooks/useToggleEditor";


export function Editor() {
//è¿½åŠ 
  const selectedId = useGetTextById((state) => state.selectedId)
  const { data, fetch }: any = useGetAllText()
  const { onClose } = useToggleEditor()

useEffect({...})
//è¿½åŠ 
const handleUpdate = async (e: SyntheticEvent) => {
        e.preventDefault();
        onClose()
        setText("")
        const apiUrl = `/api/analysis/${selectedId}`;
        const updatedData = {
            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿
            text: text,
        };
        axios.put(apiUrl, updatedData)
            .then(response => {
                toast.success('Updated!!!!')
                fetch()
                return response
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }
return(
{/* ... */}
    <div className="flex justify-end">
    {/* è¿½åŠ  */}
	<button className='mx-4 mb-2 mt-2 text-md cursor-pointer rounded-lg border-none px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white' onClick={handleUpdate}>Update</button>
	<GenarateButton textData={textData} />
    </div>
{/* ... */}
)
}
```

ã€€#### ã‚³ãƒ¼ãƒ‰ã®è§£èª¬
 ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨handleUpdateé–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
 ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå¾Œã¯ä¸€è¦§ç”»é¢ã«æˆ»ã‚ŠãŸã„ã®ã§ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‰ã˜ã¾ã™ã€‚
 apiã‚’å‘¼ã³å‡ºã—ã€ãƒ†ã‚­ã‚¹ãƒˆã®æ›´æ–°ã‚’ã—ã¾ã™ã€‚
 ```js
 onClose()ã€€//é–‹ã„ã¦ã„ã‚‹ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‰ã˜ã‚‹
 
 //æ›´æ–°ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ(useStateã®å€¤)ã‚’axiosã‚’ä½¿ã„ã€apiã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
  const updatedData = {
            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿
            text: text,
        };
        axios.put(apiUrl, updatedData)
            .then(response => {
                toast.success('Updated!!!!')
                fetch()
                return response
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
 ```

ã“ã‚Œã§ä»¥ä¸‹ã®ã‚ˆã†ã«æ›´æ–°ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/c75d92541b2a-20230929.png)
![](https://storage.googleapis.com/zenn-user-upload/7ecd0f3ddff0-20230929.png)

## ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
axios.deleteã¨ã™ã‚‹ã“ã¨ã§ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ãŒã§ãã¾ã™ã€‚
app/components/Editor/text-editor.tsx
```js
export function Editor() {
useEffect({...})

//è¿½åŠ 
const handleDelete = async (e: SyntheticEvent) => {
        e.preventDefault();
        onClose()
        const apiUrl = `/api/analysis/${selectedId}`;
        axios.delete(apiUrl)
            .then(response => {
                fetch()
                return
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }
return(
{/* ... */}
    <div className="flex justify-end">
    {/* è¿½åŠ  */}
<button className='mx-4 mb-2 mt-2 text-md cursor-pointer rounded-lg border-none px-4 py-2 bg-red-600 hover:bg-red-700 text-white' onClick={handleDelete}>Delete</button>
	<GenarateButton textData={textData} />
    </div>
{/* ... */}
)
}
```

å…ˆã»ã©æ›´æ–°ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/d7d1af9beee0-20230929.png)

ã“ã‚Œã§ã‚¨ãƒ‡ã‚£ã‚¿æ©Ÿèƒ½ã®ä½œæˆã¯çµ‚äº†ã§ã™ã€‚

<br />
<br />

## Emotionã‚’æ›´æ–°
æ„Ÿæƒ…åˆ†æã¯GenarateButtonã§ã—ã¦ã„ã¾ã™ã®ã§ã€ã“ã‚Œã«APIã®PUTãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚
app/components/GenarateButton/index.tsx
```js
"use client"

//è¿½åŠ 
import axios from "axios";
import { useGetTextById } from "@/app/hooks/useGetTextById";


export function GenarateButton({
  textData,
}: {
  textData: string
}) {
//è¿½åŠ 
  const selectedId = useGetTextById((state) => state.selectedId)

  const handleSubmit = async (e: { preventDefault: () => void }) => {
  ...
    }) : [];


//è¿½åŠ 
    const apiUrl = `/api/openai/${selectedId}`;
    const updatedData = {
      emotion: filterData,
    };

    axios.put(apiUrl, updatedData)
      .then(response => {
        toast.success('Generated!!!!')
        // fetchIsNaisei()
        return response
      })
      .catch(error => {
        console.error('Error fetching data:', error);
      });
  };

  return (
    <>
      <button
        onClick={handleSubmit}
        className="mx-4 mb-2 mt-2 text-md cursor-pointer rounded-lg border-none px-4 py-2 bg-lime-600 hover:bg-lime-700 text-white"
      >
        Generate
      </button>
      {/* å‰Šé™¤ */}
{/* <div className="text-2xl">{generateData}</div> */}
    </ >

  )
}
```

ã“ã‚Œã§emotionã®æ›´æ–°ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/c020c2f63766-20230929.png)
ã“ã‚Œã‚’Generateã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/da53b0ea90eb-20230929.png)
Supabaseã®emotionã‚«ãƒ©ãƒ ã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚

<br />
<br />
